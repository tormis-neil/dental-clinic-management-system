 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Patient Profile ‚Äî Kit & Dom's Dental Clinic</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;background:#F7F8FA;margin:0;padding:0;color:#1A1A1A;
}

/* Page container ‚Äî matches dashboard padding */
.page-wrapper{
  padding:32px;margin-top:70px;margin-left:240px;
}

/* Top bar */
.page-title{
  font-family:'Poppins',sans-serif;font-size:22px;font-weight:600;margin-bottom:6px;
}
.page-sub{
  font-size:14px;color:#64748B;margin-bottom:18px;
}

/* Layout grid */
.profile-layout{
  display:flex;gap:24px;align-items:flex-start;
}

/* Left card */
.profile-card{
  width:320px;background:#fff;border-radius:12px;padding:20px;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}
.profile-name{
  font-family:'Poppins';font-size:20px;font-weight:600;margin-bottom:6px;
}
.info-row{
  font-size:14px;margin-bottom:8px;color:#334155;
}
.label{font-size:12px;color:#64748B;text-transform:uppercase;display:block;margin-bottom:2px}
.status-badge{
  display:inline-block;padding:6px 12px;border-radius:999px;font-size:13px;font-weight:600;
}
.status-active{background:rgba(16,185,129,0.1);color:#10B981}
.status-inactive{background:#F3F4F6;color:#94A3B8}
.last-visit{font-size:13px;color:#64748B;margin-top:6px}

/* Buttons */
.action-bar{
  display:flex;gap:10px;justify-content:flex-end;margin-bottom:16px;
}
.btn{
  padding:8px 14px;border-radius:8px;font-size:14px;border:0;cursor:pointer;font-weight:500
}
.btn-primary{
  background:#E8B4BC;color:#fff;box-shadow:0 2px 6px rgba(232,180,188,0.3);
}
.btn-primary:hover{background:#D89BA7}
.btn-outline{
  background:#fff;color:#E8B4BC;border:2px solid #E8B4BC;
}
.btn-outline:hover{background:#E8B4BC;color:#fff}

/* Tabs */
.tabs{display:flex;border-bottom:1px solid #E2E8F0;margin-bottom:16px;}
.tab-btn{
  padding:10px 18px;font-size:14px;border:0;background:transparent;cursor:pointer;color:#64748B;
}
.tab-btn.active{
  color:#E8B4BC;font-weight:600;border-bottom:3px solid #E8B4BC;
}

/* Content cards */
.card{
  background:#fff;border-radius:12px;padding:20px;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}

/* Table */
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid #E2E8F0;text-align:left}
th{font-size:12px;color:#64748B;text-transform:uppercase}
</style>
</head>
<body>

<div class="page-wrapper">

  <div class="page-title">Patient Profile</div>
  <div class="page-sub">View medical information, visits, and history</div>

  <!-- Quick Actions -->
  <div class="action-bar">
    <button class="btn btn-outline" onclick="goBack()">‚Üê Back</button>
    <button class="btn btn-outline" onclick="editPatient()">Edit</button>
    <button class="btn btn-outline" onclick="addVisit()">+ Visit</button>
    <button class="btn btn-primary" id="btnDeletePatient" onclick="deletePatient()">Delete</button>
  </div>

  <div class="profile-layout">

    <!-- LEFT PATIENT CARD -->
    <div class="profile-card">
      <div class="profile-name" id="ptName"></div>

      <div class="info-row">
        <span class="label">Patient ID</span>
        <span id="ptId"></span>
      </div>

      <div class="info-row">
        <span class="label">Contact</span>
        <span id="ptContact"></span>
      </div>

      <div class="info-row">
        <span class="label">Gender</span>
        <span id="ptGender"></span>
      </div>

      <div class="info-row">
        <span class="label">Date of Birth</span>
        <span id="ptDOB"></span>
      </div>

      <div class="info-row">
        <span class="label">Age</span>
        <span id="ptAge"></span>
      </div>

      <div class="info-row">
        <span class="label">Address</span>
        <span id="ptAddress"></span>
      </div>

      <div class="info-row" style="margin-top:12px;">
        <span class="label">Status</span>
        <span id="ptStatus" class="status-badge"></span>
      </div>

      <div class="last-visit"><strong>Last Visit:</strong> <span id="ptLastVisit"></span></div>
    </div>

    <!-- RIGHT PANEL -->
    <div style="flex:1">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('visits')" id="tabVisits">Visit History</button>
        <button class="tab-btn" onclick="switchTab('medical')" id="tabMedical">Medical History</button>
      </div>

      <div id="visitsPanel" class="card">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Provider</th><th>Service</th><th>Notes</th>
            </tr>
          </thead>
          <tbody id="visitRows"></tbody>
        </table>
      </div>

     <div id="medicalPanel" class="card" style="display:none;">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
    <span style="font-size:14px;color:#64748B;">Medical Information</span>
    <button class="btn btn-outline" onclick="editMedicalInfo()">Edit Medical Info</button>
  </div>

  <div class="info-row">
          <span class="label">Allergies</span>
          <div id="medAllergies">‚Äî</div>
        </div>

        <div class="info-row">
          <span class="label">Existing Conditions</span>
          <div id="medConditions">‚Äî</div>
        </div>

        <div class="info-row">
          <span class="label">Dentist Notes / Diagnosis</span>
          <div id="medDentistNotes">‚Äî</div>
        </div>

        <div class="info-row">
          <span class="label">Assigned Dentist</span>
          <div id="medAssignedDentist">‚Äî</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* DEMO PATIENT DATA (fallback) */
const demoPatient = {
  id: "PT-0002",
  name: "Peter Dela Cruz",
  gender: "Male",
  dob: "1980-02-01",
  birth: "1980-02-01",
  contact: "09179876543",
  address: "Quezon City, PH",
  status: "active",
  lastVisit: "2025-10-10",
  visits: [
    { date: "2025-10-10", provider: "Dr. Santos", service: "Filling", notes: "Tooth #24 filling" },
    { date: "2025-06-14", provider: "Dr. Santos", service: "Cleaning", notes: "Routine cleaning" }
  ],
  medical: {
    allergies: "Penicillin",
    conditions: "Hypertension",
    dentistNotes: "Monitor blood pressure prior to operative procedures",
    assignedDentist: "Dr. Maria Santos"
  }
};

/* Try to load the selected patient from localStorage (set by patients.html or other pages).
   If not found, fall back to demoPatient so the page still renders in standalone mode. */
let patient = JSON.parse(localStorage.getItem("selectedPatient") || "null");
if (!patient) patient = demoPatient;

/* Role for demo ‚Äî change to 'manager' to preview manager actions */
const role = "staff"; // or 'manager'
const deleteBtn = document.getElementById("btnDeletePatient");

/* Delete button label/state according to role and pending requests */
if (role === "manager") {
  deleteBtn.textContent = "Delete";
} else {
  // check pending request state
  let requests = JSON.parse(localStorage.getItem("deleteRequests") || "[]");
  const pending = requests.some(r => r.patientId === patient.id && r.status === "pending");

  if (pending) {
    deleteBtn.textContent = "Pending Approval";
    deleteBtn.disabled = true;
    deleteBtn.style.opacity = "0.6";
    deleteBtn.style.cursor = "not-allowed";
  } else {
    deleteBtn.textContent = "Request Delete";
  }
}

/* Populate UI */
document.getElementById("ptName").textContent = patient.firstName
  ? `${patient.firstName} ${patient.lastName}` : (patient.name || "‚Äî");
document.getElementById("ptId").textContent = patient.id || "‚Äî";
document.getElementById("ptGender").textContent = patient.gender || "‚Äî";
document.getElementById("ptDOB").textContent = patient.birth || patient.dob || "‚Äî";
document.getElementById("ptContact").textContent = patient.contact || "‚Äî";
document.getElementById("ptAddress").textContent = patient.address || "‚Äî";
document.getElementById("ptLastVisit").textContent = patient.lastVisit || "‚Äî";

const age = (patient.birth || patient.dob)
  ? Math.floor((Date.now() - new Date(patient.birth || patient.dob)) / (1000 * 60 * 60 * 24 * 365.25))
  : "‚Äî";
document.getElementById("ptAge").textContent = age;

const statusEl = document.getElementById("ptStatus");
statusEl.textContent = patient.status === "active" ? "Active" : "Inactive";
statusEl.classList.add(patient.status === "active" ? "status-active" : "status-inactive");

/* Visits table */
let rows = "";
if (patient.visits && patient.visits.length) {
  patient.visits.forEach(v => {
    rows += `<tr>
      <td>${v.date}</td><td>${v.provider}</td><td>${v.service}</td><td>${v.notes}</td>
    </tr>`;
  });
} else {
  rows = `<tr><td colspan="4" style="text-align:center;color:#94A3B8">No visits recorded.</td></tr>`;
}
document.getElementById("visitRows").innerHTML = rows;

/* Medical info */
document.getElementById("medAllergies").textContent = (patient.medical && patient.medical.allergies) || "‚Äî";
document.getElementById("medConditions").textContent = (patient.medical && patient.medical.conditions) || "‚Äî";
document.getElementById("medDentistNotes").textContent = (patient.medical && patient.medical.dentistNotes) || "‚Äî";
document.getElementById("medAssignedDentist").textContent = (patient.medical && patient.medical.assignedDentist) || "‚Äî";

/* Tabs */
function switchTab(tab) {
  document.getElementById("visitsPanel").style.display = tab === "visits" ? "" : "none";
  document.getElementById("medicalPanel").style.display = tab === "medical" ? "" : "none";
  document.getElementById("tabVisits").classList.toggle("active", tab === "visits");
  document.getElementById("tabMedical").classList.toggle("active", tab === "medical");
}

/* Navigation + buttons */
/* goBack: always navigate to patients.html (works even if there is no history or opened directly) */
function goBack() {
  // prefer history.back if the referrer is our patients page, otherwise jump to patients.html
  try {
    if (document.referrer && document.referrer.indexOf('patients.html') !== -1) {
      history.back();
      return;
    }
  } catch (e) { /* ignore */ }

  // fallback: direct navigation
  window.location.href = "patients.html";
}

/* editPatient: store patient in localStorage (so edit page can load the same patient) then navigate */
function editPatient() {
  try {
    localStorage.setItem("selectedPatient", JSON.stringify(patient));
  } catch (e) {
    console.warn("Could not save selectedPatient to localStorage:", e);
  }
  window.location.href = "patient_edit.html";
}

/* addVisit: store patient and open visit add page */
function addVisit() {
  try {
    localStorage.setItem("selectedPatient", JSON.stringify(patient));
  } catch (e) {
    console.warn("Could not save selectedPatient to localStorage:", e);
  }
  window.location.href = "visit_add.html";
}

/* deletePatient: same logic as before (demo) */
function deletePatient() {
  if (role === "manager") {
    const confirmed = confirm("Are you sure you want to delete this patient record?");
    if (!confirmed) return;
    alert("‚úÖ Patient record deleted (demo)");
    // TODO: perform actual deletion and redirect to patients.html
    return;
  }

  let requests = JSON.parse(localStorage.getItem("deleteRequests") || "[]");
  const exists = requests.some(r => r.patientId === patient.id && r.status === "pending");
  if (exists) {
    alert("üïì Delete request already pending approval.");
    return;
  }

  const confirmReq = confirm("Send delete request to Manager for approval?");
  if (!confirmReq) return;

  const request = {
    patientId: patient.id,
    patientName: patient.name || `${patient.firstName || ''} ${patient.lastName || ''}`.trim(),
    requestedBy: "Staff User",
    date: new Date().toISOString(),
    status: "pending"
  };

  requests.push(request);
  localStorage.setItem("deleteRequests", JSON.stringify(requests));

  alert("‚úÖ Delete request submitted to manager.");
  deleteBtn.disabled = true;
  deleteBtn.textContent = "Pending Approval";
  deleteBtn.style.opacity = "0.6";
  deleteBtn.style.cursor = "not-allowed";
}

function editMedicalInfo() {
  try {
    localStorage.setItem("selectedPatient", JSON.stringify(patient));
  } catch (e) {
    console.warn("Could not save patient data:", e);
  }
  window.location.href = "edit_medical_page.html";
}

</script>
</body>
</html>
