 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Patient Records - Kit & Dom's Dental Clinic</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  /* --- Base --- */
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:'Inter',sans-serif;
    background:#F7F8FA;
    color:#1A1A1A;
    overflow:hidden;
  }

  /* --- Header (matches Dashboard) --- */
  .header{
    height:70px;background:#fff;border-bottom:1px solid #E2E8F0;
    display:flex;align-items:center;justify-content:space-between;padding:0 32px;
    position:fixed;top:0;left:0;right:0;z-index:100;gap:24px;
  }
  .header-left{display:flex;align-items:center;gap:16px;min-width:0}
  .sidebar-toggle{width:36px;height:36px;background:transparent;border:0;border-radius:6px;color:#64748B;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s}
  .sidebar-toggle:hover{background:rgba(232,180,188,0.12);color:#E8B4BC}
  .header-logo{font-size:24px}
  .header-title{font-family:'Poppins',sans-serif;font-weight:600;font-size:18px;color:#1A1A1A;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .search-container{flex:1;max-width:480px;position:relative}
  .search-input{width:100%;padding:8px 16px 8px 40px;border:1px solid #E2E8F0;border-radius:8px;font-size:14px}
  .search-input:focus{border-color:#E8B4BC;box-shadow:0 0 0 3px rgba(232,180,188,0.1)}
  .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#94A3B8;width:18px;height:18px}

  .header-right{display:flex;align-items:center;gap:16px}
  .role-switcher{display:flex;align-items:center;gap:8px;padding:4px;background:#F7F8FA;border-radius:8px;border:1px solid #E2E8F0}
  .role-switch-btn{padding:6px 14px;border-radius:6px;border:0;background:transparent;color:#64748B;cursor:pointer;font-weight:500}
  .role-switch-btn.active{background:#E8B4BC;color:#fff;box-shadow:0 2px 4px rgba(232,180,188,0.3)}

  .user-trigger{display:flex;align-items:center;gap:10px;padding:6px 12px;border-radius:8px;border:1px solid #E2E8F0;background:transparent;cursor:pointer}
  .user-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#E8B4BC,#D89BA7);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600}
  .user-name{font-weight:500;font-size:14px}
  .user-role{font-size:12px;color:#64748B}

  /* --- Sidebar (matches Dashboard) --- */
  .sidebar{width:240px;background:#fff;border-right:1px solid #E2E8F0;position:fixed;left:0;top:70px;bottom:0;padding:24px 0;overflow:auto;z-index:90;transition:all .3s}
  .sidebar.collapsed{width:60px}
  .sidebar-item{display:flex;align-items:center;gap:12px;padding:12px 24px;color:#64748B;font-weight:500;cursor:pointer;transition:all .3s;white-space:nowrap;position:relative}
  .sidebar-item:hover{background:rgba(232,180,188,0.12);color:#E8B4BC}
  .sidebar-item.active{background:#E8B4BC;color:#fff;font-weight:600}
  .sidebar-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:#D89BA7}
  .sidebar-label{transition:opacity .3s}
  .sidebar.collapsed .sidebar-label{opacity:0;width:0;overflow:hidden}

  /* icon sizing + stroke color (Lucide style) */
  .sidebar-item svg { width:18px; height:18px; stroke:#64748B; stroke-width:2; fill:none; stroke-linecap:round; stroke-linejoin:round; }
  .sidebar-item:hover svg { stroke:#E8B4BC; }

  /* --- Main content area --- */
  .main-content{margin-left:240px;margin-top:70px;padding:32px;min-height:calc(100vh - 70px);transition:margin-left .3s;overflow:auto}
  .main-content.expanded{margin-left:60px}

  .page-title{font-family:'Poppins',sans-serif;font-weight:600;font-size:22px;margin-bottom:6px}
  .page-sub{font-size:14px;color:#64748B;margin-bottom:20px}

  /* --- Action row & filters --- */
  .action-row{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
  .left-actions{display:flex;gap:12px;align-items:center}
  .filters{display:flex;gap:12px;align-items:center}
  .filter-input,.filter-select{padding:8px 12px;border-radius:8px;border:1px solid #E2E8F0;background:#fff;font-size:14px}
  .primary-btn{padding:10px 18px;border-radius:10px;border:0;background:#E8B4BC;color:#fff;font-family:'Poppins';cursor:pointer;box-shadow:0 2px 6px rgba(232,180,188,0.3)}
  .primary-btn:hover{background:#D89BA7;transform:translateY(-2px)}
  .secondary-btn{padding:8px 14px;border-radius:8px;border:2px solid #E8B4BC;background:#fff;color:#E8B4BC;cursor:pointer}
  .secondary-btn:hover{background:#E8B4BC;color:#fff}

  /* --- Table --- */
  .table-card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
  .table-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .table-wrapper{overflow-x:auto}
  table{width:100%;border-collapse:collapse}
  thead{background:#F7F8FA}
  th{padding:12px;text-align:left;font-weight:600;font-size:13px;color:#64748B;text-transform:uppercase;letter-spacing:.5px}
  td{padding:12px;border-top:1px solid #E2E8F0;font-size:14px;color:#1A1A1A}
  tbody tr:hover{background:rgba(232,180,188,0.06)}
  .record-id{color:#9B8FD9;font-weight:500}
  .badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;font-weight:500;font-size:13px}
  .badge.active{background:rgba(16,185,129,0.08);color:#10B981}
  .badge.inactive{background:#F3F4F6;color:#94A3B8}

  .action-icons{display:flex;gap:8px;align-items:center}
  .action-icons button{background:transparent;border:0;cursor:pointer;padding:6px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center}
  .action-icons svg{width:18px;height:18px;stroke:#64748B;stroke-width:2;fill:none;stroke-linecap:round;stroke-linejoin:round}
  .action-icons button:hover svg{stroke:#E8B4BC}
  .icon-delete svg{stroke:#EF4444}
  .icon-delete:hover svg{stroke:#EF4444; background: rgba(239,68,68,0.06); }

  /* --- Modals --- */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal{width:720px;max-width:calc(100% - 48px);background:#fff;border-radius:12px;padding:20px;box-shadow:0 8px 40px rgba(0,0,0,0.2)}
  .modal h3{font-family:'Poppins';font-weight:600;margin-bottom:8px}
  .modal .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
  .modal label{display:block;font-size:13px;color:#64748B;margin-bottom:6px}
  .modal input,.modal textarea,.modal select{width:100%;padding:8px;border-radius:8px;border:1px solid #E2E8F0;font-size:14px}
  .modal textarea{min-height:100px;resize:vertical}
  .modal-footer{display:flex;justify-content:flex-end;gap:12px;margin-top:12px}

  /* --- Empty state --- */
  .empty-state{padding:40px;text-align:center;color:#64748B}

  /* --- Footer --- */
  .footer{padding:20px;text-align:center;color:#64748B;font-size:12px;position:fixed;bottom:0;left:240px;right:0;background:transparent}

  /* --- Utilities --- */
  .muted{color:#64748B;font-size:13px}
  .hidden{display:none}
  .flex-center{display:flex;align-items:center;gap:8px}

  /* --- Desktop-only banner for smaller widths --- */
  @media (max-width:1024px){
    body::before{content:'This system is optimized for desktop use. Please access from a desktop computer.';position:fixed;top:0;left:0;right:0;background:#FEF3C7;color:#92400E;padding:12px;text-align:center;z-index:3000;border-bottom:2px solid #FCD34D}
  }
</style>
</head>
<body data-role="manager">

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
      <div class="header-logo">ðŸ¦·</div>
      <div class="header-title">Kit &amp; Dom's Dental Clinic â€” Patient Records</div>
    </div>

    <div class="search-container" id="globalSearchWrap">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input id="globalSearch" class="search-input" placeholder="Search patient name, ID, or contact..." />
    </div>

    <div class="header-right">
      <div class="role-switcher" title="Demo role switch">
        <button id="managerBtn" class="role-switch-btn active" onclick="switchRole('manager')">Manager</button>
        <button id="staffBtn" class="role-switch-btn" onclick="switchRole('staff')">Staff</button>
      </div>

      <div class="user-trigger" onclick="toggleUserMenu()">
        <div class="user-avatar" id="userAvatar">MS</div>
        <div>
          <div class="user-name" id="userName">Dr. Maria Santos</div>
          <div class="user-role" id="userRole">Manager / Dentist</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Sidebar -->
  <nav id="sidebar" class="sidebar">
    <div class="sidebar-item" onclick="navigateTo('dashboard')" data-tooltip="Dashboard">
      <!-- Lucide: home -->
      <svg viewBox="0 0 24 24" fill="none" stroke="#64748B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
        <path d="M3 9.5L12 3l9 6.5"></path>
        <path d="M9 22V12h6v10"></path>
      </svg>
      <span class="sidebar-label">Dashboard</span>
    </div>

    <div class="sidebar-item active" onclick="navigateTo('patients')" data-tooltip="Patients">
      <!-- Lucide: users -->
      <svg viewBox="0 0 24 24" fill="none" stroke="#64748B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
      <span class="sidebar-label">Patients</span>
    </div>

    <div class="sidebar-item manager-only" onclick="navigateTo('team')" data-tooltip="Team Management">
      <!-- Lucide: user-check -->
      <svg viewBox="0 0 24 24" fill="none" stroke="#64748B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="8.5" cy="7" r="4"></circle>
        <path d="M17 11l2 2 4-4"></path>
      </svg>
      <span class="sidebar-label">Team Management</span>
    </div>

    <div class="sidebar-item manager-only" onclick="navigateTo('logs')" data-tooltip="Audit Logs">
      <!-- Lucide: list -->
      <svg viewBox="0 0 24 24" fill="none" stroke="#64748B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
      <span class="sidebar-label">Audit Logs</span>
    </div>

    <div class="sidebar-item manager-only" onclick="navigateTo('backup')" data-tooltip="Backup & Restore">
      <!-- Lucide: database -->
      <svg viewBox="0 0 24 24" fill="none" stroke="#64748B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
        <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
        <path d="M3 5v6c0 1.7 4 3 9 3s9-1.3 9-3V5"></path>
        <path d="M3 12v6c0 1.7 4 3 9 3s9-1.3 9-3v-6"></path>
      </svg>
      <span class="sidebar-label">Backup & Restore</span>
    </div>

    <div class="sidebar-item" onclick="navigateTo('settings')" data-tooltip="Account Settings">
      <!-- Lucide: settings -->
      <svg viewBox="0 0 24 24" fill="none" stroke="#64748B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82L4.3 4.3A2 2 0 0 1 7.12 1.47l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09c.1.6.55 1.12 1.17 1.39l.06.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.43.2.83.5 1.17.87z"></path>
      </svg>
      <span class="sidebar-label">Account Settings</span>
    </div>
  </nav>

  <!-- Main content -->
  <main id="mainContent" class="main-content">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:420px">
        <div class="page-title">Patient Records</div>
        <div class="page-sub">Manage and view registered patient information. Use filters to narrow results.</div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="muted">Showing <span id="recordsCount">â€”</span> patients</div>
      </div>
    </div>

    <!-- Action row -->
    <div class="action-row" style="margin-top:12px">
      <div class="left-actions">
        <button class="primary-btn" id="btnAddPatient" onclick="openAddModal()">+ Add New Patient</button>
        <button class="secondary-btn manager-only" id="btnExport" onclick="exportCSV()">Export (CSV)</button>
        <button class="secondary-btn manager-only" id="btnDeleteSelected" onclick="deleteSelected()">Delete Selected</button>
      </div>

      <div class="filters">
        <input id="searchInput" class="filter-input" placeholder="Search by name or ID" />
        <select id="genderFilter" class="filter-select">
          <option value="">All genders</option>
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>
        <select id="statusFilter" class="filter-select">
          <option value="">All status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
        <button class="secondary-btn" onclick="resetFilters()">Reset</button>
      </div>
    </div>

    <!-- Table -->
    <div class="table-card" style="margin-top:18px">
      <div class="table-header">
        <div style="font-weight:600">All Patients</div>
        <div class="muted">Quick actions available</div>
      </div>

      <div class="table-wrapper">
        <table id="patientsTable">
          <!-- rendered by JS -->
        </table>
      </div>
    </div>

    <!-- Footer -->
    <div style="height:72px"></div>
  </main>

  <footer class="footer">Â© 2025 Kit &amp; Dom's Dental Clinic | Version 1.1</footer>

  <!-- Modals -->
  <div id="modalBackdrop" class="modal-backdrop" onclick="closeModal(event)">
    <div id="modal" class="modal" onclick="event.stopPropagation()">
      <!-- content injected by JS -->
    </div>
  </div>

<script>
/* -------------------------
   Demo data + state
   ------------------------- */
let currentRole = 'manager'; // default (manager or staff)
document.body.setAttribute('data-role', currentRole);

const demoPatients = [
  { id: 'PT-0001', lastName:'Cruz', firstName:'Jane', gender:'Female', birth:'1995-06-12', contact:'09171234567', lastVisit:'2025-10-18', status:'active', notes:'Routine cleaning' },
  { id: 'PT-0002', lastName:'Dela Cruz', firstName:'Peter', gender:'Male', birth:'1980-02-01', contact:'09179876543', lastVisit:'2025-10-10', status:'active', notes:'Filling' },
  { id: 'PT-0003', lastName:'Garcia', firstName:'Anna', gender:'Female', birth:'2004-11-20', contact:'09170001111', lastVisit:'2024-12-05', status:'inactive', notes:'Moved away' },
  { id: 'PT-0004', lastName:'Doe', firstName:'John', gender:'Male', birth:'1972-08-08', contact:'09171112222', lastVisit:'2025-09-01', status:'active', notes:'Root canal' }
];

let patients = JSON.parse(JSON.stringify(demoPatients)); // working copy
let selectedIds = new Set();

/* -------------------------
   Role switcher
   ------------------------- */
function switchRole(role){
  currentRole = role;
  document.body.setAttribute('data-role', role);
  document.getElementById('managerBtn').classList.toggle('active', role==='manager');
  document.getElementById('staffBtn').classList.toggle('active', role==='staff');

  // UI adjustments: hide manager-only elements for staff
  document.querySelectorAll('.manager-only').forEach(el=>{
    el.style.display = (role==='manager') ? '' : 'none';
  });

  // update user info
  if(role==='manager'){
    document.getElementById('userName').textContent = 'Dr. Maria Santos';
    document.getElementById('userRole').textContent = 'Manager / Dentist';
    document.getElementById('userAvatar').textContent = 'MS';
    document.getElementById('globalSearchWrap').style.display = '';
  } else {
    document.getElementById('userName').textContent = 'Carla Reyes';
    document.getElementById('userRole').textContent = 'Staff';
    document.getElementById('userAvatar').textContent = 'CR';
    document.getElementById('globalSearchWrap').style.display = 'none';
  }

  renderTable();
}

/* -------------------------
   Sidebar toggle
   ------------------------- */
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('collapsed');
  document.getElementById('mainContent').classList.toggle('expanded');
}

/* -------------------------
   Utilities
   ------------------------- */
function ageFromDOB(dob){
  if(!dob) return '';
  const b = new Date(dob);
  const diff = Date.now() - b.getTime();
  const age = Math.floor(diff / (1000*60*60*24*365.25));
  return age;
}

/* -------------------------
   Render table
   ------------------------- */
function renderTable(){
  const table = document.getElementById('patientsTable');
  const cols = currentRole==='manager'
    ? ['Select','Patient ID','Full Name','Gender','Age','Contact','Last Visit','Status','Actions']
    : ['Patient ID','Full Name','Gender','Age','Contact','Last Visit','Status','Actions'];

  // header
  const thead = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>`;

  // body
  const bodyRows = patients.map(p=>{
    const fullName = `${p.firstName} ${p.lastName}`;
    const age = ageFromDOB(p.birth);
    const rowSelect = `<td style="width:56px"><input type="checkbox" onchange="toggleSelect('${p.id}',this)" ${selectedIds.has(p.id)?'checked':''} /></td>`;
    const idCell = `<td class="record-id">${p.id}</td>`;
    const nameCell = `<td><strong>${p.firstName} ${p.lastName}</strong></td>`;
    const genderCell = `<td>${p.gender}</td>`;
    const ageCell = `<td>${age}</td>`;
    const contactCell = `<td>${p.contact}</td>`;
    const visitCell = `<td>${p.lastVisit || 'â€”'}</td>`;
    const statusCell = `<td><span class="badge ${p.status==='active'?'active':'inactive'}">${p.status==='active'?'Active':'Inactive'}</span></td>`;

    const viewBtn = `<button class="icon-view" title="View" onclick="openViewModal('${p.id}')">
      <!-- Lucide: eye -->
      <svg viewBox="0 0 24 24" stroke="#64748B" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
    </button>`;

    const editBtn = `<button class="icon-edit" title="Edit" onclick="openEditModal('${p.id}')">
      <!-- Lucide: edit -->
      <svg viewBox="0 0 24 24" stroke="#64748B" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
    </button>`;

    const deleteBtn = `<button class="icon-delete manager-only" title="Delete" onclick="confirmDelete('${p.id}')">
      <!-- Lucide: trash-2 -->
      <svg viewBox="0 0 24 24" stroke="#EF4444" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    </button>`;

    const actionCell = `<td class="action-icons">${viewBtn}${editBtn}${deleteBtn}</td>`;

    if(currentRole==='manager'){
      return `<tr>${rowSelect}${idCell}${nameCell}${genderCell}${ageCell}${contactCell}${visitCell}${statusCell}${actionCell}</tr>`;
    } else {
      return `<tr>${idCell}${nameCell}${genderCell}${ageCell}${contactCell}${visitCell}${statusCell}${actionCell}</tr>`;
    }
  }).join('');

  const tbody = `<tbody>${bodyRows || `<tr><td colspan="${cols.length}" class="empty-state">No patients found. Click Add New Patient to create one.</td></tr>`}</tbody>`;

  table.innerHTML = thead + tbody;
  document.getElementById('recordsCount').textContent = patients.length;
  // hide manager-only elements if staff
  document.querySelectorAll('.manager-only').forEach(el=>{
    el.style.display = (currentRole==='manager') ? '' : 'none';
  });
}

/* -------------------------
   Selection
   ------------------------- */
function toggleSelect(id, checkbox){
  if(checkbox.checked) selectedIds.add(id); else selectedIds.delete(id);
}

/* -------------------------
   Filters + Search
   ------------------------- */
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('genderFilter').addEventListener('change', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('globalSearch').addEventListener('input', function(e){
  const q = e.target.value.trim().toLowerCase();
  if(q.length < 3){ renderTable(); return; }
  const hits = patients.filter(p => `${p.firstName} ${p.lastName} ${p.id} ${p.contact}`.toLowerCase().includes(q));
  renderFiltered(hits);
});

function applyFilters(){
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const gender = document.getElementById('genderFilter').value;
  const status = document.getElementById('statusFilter').value;

  let results = demoPatients.slice();
  if(q) results = results.filter(p => (`${p.firstName} ${p.lastName} ${p.id}`).toLowerCase().includes(q));
  if(gender) results = results.filter(p => p.gender === gender);
  if(status) results = results.filter(p => p.status === status);
  patients = results;
  selectedIds.clear();
  renderTable();
}

function renderFiltered(list){
  patients = list;
  selectedIds.clear();
  renderTable();
}

function resetFilters(){ document.getElementById('searchInput').value=''; document.getElementById('genderFilter').value=''; document.getElementById('statusFilter').value=''; patients = demoPatients.slice(); selectedIds.clear(); renderTable(); }

/* -------------------------
   Modals: View / Add / Edit
   ------------------------- */
const backdrop = document.getElementById('modalBackdrop');
const modalEl = document.getElementById('modal');

function openViewModal(id){
  const p = patients.find(x=>x.id===id) || demoPatients.find(x=>x.id===id);
  if(!p) return alert('Patient not found');
  modalEl.innerHTML = `
    <h3>Patient Details</h3>
    <div class="row">
      <div><label>Patient ID</label><div class="muted">${p.id}</div></div>
      <div><label>Full Name</label><div><strong>${p.firstName} ${p.lastName}</strong></div></div>
    </div>
    <div class="row">
      <div><label>Gender</label><div class="muted">${p.gender}</div></div>
      <div><label>Age</label><div class="muted">${ageFromDOB(p.birth)}</div></div>
    </div>
    <div class="row">
      <div><label>Contact</label><div class="muted">${p.contact}</div></div>
      <div><label>Last Visit</label><div class="muted">${p.lastVisit || 'â€”'}</div></div>
    </div>
    <div style="margin-top:8px"><label>Notes</label><div class="muted">${p.notes || 'â€”'}</div></div>
    <div class="modal-footer">
      <button class="secondary-btn" onclick="closeModal()">Close</button>
      ${currentRole==='manager' ? `<button class="secondary-btn" onclick="openEditModal('${p.id}')">Edit</button>` : ''}
    </div>
  `;
  openBackdrop();
}

 function openAddModal(){
  const isManager = currentRole === 'manager';
  modalEl.innerHTML = `
    <h3>Add New Patient</h3>
    <div class="row">
      <div><label>First Name</label><input id="m_firstName" required /></div>
      <div><label>Last Name</label><input id="m_lastName" required /></div>
    </div>
    <div class="row">
      <div><label>Gender</label>
        <select id="m_gender">
          <option>Female</option><option>Male</option><option>Other</option>
        </select>
      </div>
      <div><label>Date of Birth</label><input id="m_dob" type="date" /></div>
    </div>
    <div class="row">
      <div><label>Contact</label><input id="m_contact" /></div>
      <div><label>Address</label><input id="m_address" placeholder="e.g. Makati City" /></div>
    </div>

    ${isManager ? `
    <div class="row">
      <div><label>Medical History</label><textarea id="m_medical" placeholder="e.g. Allergic to anesthesia"></textarea></div>
      <div><label>Diagnosis / Notes</label><textarea id="m_notes" placeholder="e.g. Requires crown procedure"></textarea></div>
    </div>
    <div class="row">
      <div><label>Assigned Dentist</label><input id="m_assigned" value="Dr. Maria Santos" /></div>
      <div><label>Last Visit</label><input id="m_lastVisit" type="date" /></div>
      <div><label>Status</label>
        <select id="m_status">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
    </div>
    ` : `
    <div class="row">
      <div><label>Intake Notes</label><textarea id="m_notes" placeholder="Optional notes (e.g. New patient intake)"></textarea></div>
    </div>
    `}

    <div class="modal-footer">
      <button class="secondary-btn" onclick="closeModal()">Cancel</button>
      <button class="primary-btn" onclick="${isManager ? 'saveNewPatient()' : 'submitForReview()'}">
        ${isManager ? 'Save' : 'Submit for Review'}
      </button>
    </div>
  `;
  openBackdrop();
}


function openEditModal(id) {
  const p = patients.find(x => x.id === id);
  if (!p) return alert('Patient not found');

  const isManager = currentRole === 'manager';
  modalEl.innerHTML = `
    <h3>Edit Patient</h3>
    <div class="row">
      <div><label>First Name</label><input id="m_firstName" value="${p.firstName}" required /></div>
      <div><label>Last Name</label><input id="m_lastName" value="${p.lastName}" required /></div>
    </div>
    <div class="row">
      <div><label>Gender</label>
        <select id="m_gender">
          <option ${p.gender==='Female'?'selected':''}>Female</option>
          <option ${p.gender==='Male'?'selected':''}>Male</option>
          <option ${p.gender==='Other'?'selected':''}>Other</option>
        </select>
      </div>
      <div><label>Date of Birth</label><input id="m_dob" type="date" value="${p.birth}" /></div>
    </div>
    <div class="row">
      <div><label>Contact</label><input id="m_contact" value="${p.contact}" /></div>
      <div><label>Address</label><input id="m_address" value="${p.address || ''}" /></div>
      <div><label>Last Visit</label><input id="m_lastVisit" type="date" value="${p.lastVisit || ''}" /></div>
    </div>

    ${isManager ? `
    <div class="row">
      <div><label>Medical History</label><textarea id="m_medical">${p.medical || ''}</textarea></div>
      <div><label>Diagnosis / Notes</label><textarea id="m_notes">${p.notes || ''}</textarea></div>
    </div>
    <div class="row">
      <div><label>Assigned Dentist</label><input id="m_assigned" value="${p.assigned || 'Dr. Maria Santos'}" /></div>
      <div><label>Status</label>
        <select id="m_status">
          <option value="active" ${p.status==='active'?'selected':''}>Active</option>
          <option value="inactive" ${p.status==='inactive'?'selected':''}>Inactive</option>
        </select>
      </div>
    </div>
    ` : `
    <div class="row">
      <div><label>Notes</label><textarea id="m_notes">${p.notes || ''}</textarea></div>
    </div>
    `}

    <div class="modal-footer">
      <button class="secondary-btn" onclick="closeModal()">Cancel</button>
      <button class="primary-btn" onclick="saveEditPatient('${p.id}')">Save Changes</button>
    </div>
  `;
  openBackdrop();
}

/* -------------------------
   Save (Manager) & Submit (Staff)
   ------------------------- */
function saveNewPatient(){
  const firstName = document.getElementById('m_firstName').value.trim();
  const lastName = document.getElementById('m_lastName').value.trim();
  if(!firstName || !lastName){ alert('Please fill out required fields'); return; }

  const newPatient = { 
    id: generateId(),
    firstName,
    lastName,
    gender: document.getElementById('m_gender').value,
    birth: document.getElementById('m_dob').value,
    contact: document.getElementById('m_contact').value,
    address: document.getElementById('m_address').value,
    medical: document.getElementById('m_medical') ? document.getElementById('m_medical').value : '',
    notes: document.getElementById('m_notes').value,
    assigned: document.getElementById('m_assigned') ? document.getElementById('m_assigned').value : '',
    status: document.getElementById('m_status') ? document.getElementById('m_status').value : 'active',
    lastVisit: document.getElementById('m_lastVisit') ? document.getElementById('m_lastVisit').value : ''
  };

  demoPatients.unshift(newPatient);
  patients = demoPatients.slice();
  closeModal();
  renderTable();
  alert('Patient record saved successfully.');
}


function submitForReview(){
  const firstName = document.getElementById('m_firstName').value.trim();
  const lastName = document.getElementById('m_lastName').value.trim();
  if(!firstName || !lastName){ alert('Please fill out required fields'); return; }

  const newPatient = {
    id: generateId(),
    firstName,
    lastName,
    gender: document.getElementById('m_gender').value,
    birth: document.getElementById('m_dob').value,
    contact: document.getElementById('m_contact').value,
    address: document.getElementById('m_address').value,
    notes: document.getElementById('m_notes').value,
    status: 'pending-review'
  };

  demoPatients.unshift(newPatient);
  patients = demoPatients.slice();
  closeModal();
  renderTable();
  alert('Patient submitted for review. A manager will verify and approve.');
}


function saveEditPatient(id){
  const p = demoPatients.find(x=>x.id===id);
  if(!p) return alert('Not found');
  p.firstName = document.getElementById('m_firstName').value.trim();
  p.lastName = document.getElementById('m_lastName').value.trim();
  p.gender = document.getElementById('m_gender').value;
  p.birth = document.getElementById('m_dob').value;
  p.contact = document.getElementById('m_contact').value;
  p.lastVisit = document.getElementById('m_lastVisit').value;
  p.notes = document.getElementById('m_notes').value;
  patients = demoPatients.slice();
  closeModal();
  renderTable();
}

/* -------------------------
   Delete
   ------------------------- */
function confirmDelete(id){
  if(currentRole !== 'manager'){ return alert('You do not have permission to delete records'); }
  if(!confirm('Delete this patient record? This action cannot be undone.')) return;
  demoPatients = demoPatients.filter(p=>p.id !== id);
  patients = demoPatients.slice();
  selectedIds.delete(id);
  renderTable();
}

function deleteSelected(){
  if(currentRole !== 'manager'){ return alert('Permission denied'); }
  if(selectedIds.size === 0) return alert('No rows selected');
  if(!confirm(`Delete ${selectedIds.size} selected record(s)?`)) return;
  demoPatients = demoPatients.filter(p => !selectedIds.has(p.id));
  patients = demoPatients.slice();
  selectedIds.clear();
  renderTable();
}

/* -------------------------
   Export CSV (manager only)
   ------------------------- */
function exportCSV(){
  if(currentRole !== 'manager') return alert('Permission denied');
  const headers = ['Patient ID','First Name','Last Name','Gender','DOB','Contact','Last Visit','Status','Notes'];
  const rows = demoPatients.map(p => [p.id, p.firstName, p.lastName, p.gender, p.birth || '', p.contact || '', p.lastVisit || '', p.status, (p.notes||'')]);
  const csv = [headers, ...rows].map(r => r.map(field => `"${String(field).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'patients_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* -------------------------
   Helpers + small UI
   ------------------------- */
function generateId(){
  const n = Math.floor(Math.random()*9000)+1000;
  return `PT-${n}`;
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]) }

/* -------------------------
   Navigation + misc
   ------------------------- */
function navigateTo(page){ alert(`Demo: nav to ${page}`); }
function toggleUserMenu(){ alert('Demo: user menu'); }

/* -------------------------
   Modal open/close helpers
   ------------------------- */
function openBackdrop() {
  backdrop.style.display = 'flex';
}

function closeModal(event) {
  if (!event || event.target === backdrop) {
    backdrop.style.display = 'none';
    modalEl.innerHTML = '';
  }
}

/* -------------------------
   Initial render
   ------------------------- */
renderTable();

/* expose for debugging in console */
window._patients = patients;
window.switchRole = switchRole;

/* -------------------------
   Initial render
   ------------------------- */
renderTable();

/* expose for debugging in console */
window._patients = patients;
window.switchRole = switchRole;
</script>
</body>
</html>